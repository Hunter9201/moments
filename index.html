<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moments ‚Äî Social, Stories, DMs (GitHub Pages)</title>
  <meta name="description" content="GitHub-Pages‚Äìonly social app: profiles, reels, stories, and DMs. No servers." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{height:100%}
    .radial-bg{background-image:
      radial-gradient(1100px 500px at 10% -10%, rgba(59,130,246,.12), transparent),
      radial-gradient(1000px 500px at 90% -10%, rgba(217,70,239,.10), transparent)}
    .card{box-shadow:0 10px 30px rgba(2,6,23,.06)}
    .chip{font-size:.72rem;padding:.2rem .6rem;border-radius:999px;background:rgba(0,0,0,.08)}
    .mom-feed{scroll-snap-type:y mandatory; overflow-y:auto; max-height:85vh}
    .mom-item{scroll-snap-align:center}
    .story-progress{height:6px;background:rgba(255,255,255,.25)}
    .story-progress > div{height:100%;background:#fff;width:0%}
  </style>
</head>
<body class="min-h-screen radial-bg text-slate-900">

  <!-- Header -->
  <header class="sticky top-0 z-40 border-b border-black/10 bg-white/80 backdrop-blur">
    <div class="mx-auto max-w-6xl px-4 py-3">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 animate-[spin_9s_linear_infinite] rounded-xl bg-gradient-to-br from-sky-300 via-fuchsia-300 to-amber-300"></div>
          <div>
            <div class="text-xs uppercase tracking-widest text-black/60">Moments</div>
            <div class="text-lg font-extrabold leading-5">Instinct social ‚Äî Pages only</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <input id="search" placeholder="Search moments‚Ä¶" class="w-56 max-w-[60vw] rounded-full border border-black/10 bg-white/70 px-4 py-2 text-sm shadow-sm outline-none placeholder:text-black/40 focus:border-black/20 focus:ring-2 focus:ring-black/10" />
          <button id="btnSignIn" class="rounded-full border border-black/10 bg-white/70 px-3 py-1 text-xs font-semibold shadow-sm">üîê Sign in</button>
          <span id="userBadge" class="hidden rounded-full border border-black/10 bg-white/70 px-3 py-1 text-xs font-semibold shadow-sm"></span>
          <button id="btnSignOut" class="hidden rounded-full border border-black/10 bg-white/70 px-3 py-1 text-xs font-semibold shadow-sm">Sign out</button>
          <button id="openSettings" class="rounded-full border border-black/10 bg-white/70 px-3 py-1 text-xs font-semibold shadow-sm">‚öô</button>
        </div>
      </div>
      <nav class="mt-3 flex flex-wrap gap-2">
        <button data-tab="home" class="tab-btn rounded-full bg-white px-3 py-1 text-xs font-semibold shadow">Feed</button>
        <button data-tab="moments" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70">Moments</button>
        <button data-tab="chat" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70">Communication</button>
        <button data-tab="profile" class="tab-btn rounded-full px-3 py-1 text-xs font-semibold text-black/70">Profile</button>
      </nav>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-6 space-y-8">

    <!-- HOME FEED (reads from indexes/moments.json) -->
    <section id="tab-home" class="space-y-6">
      <div class="rounded-2xl border border-black/10 bg-white/80 p-4 card">
        <div class="flex items-center justify-between">
          <div class="text-xs uppercase tracking-widest text-black/50">For You</div>
          <div class="flex gap-2 text-xs"><span class="chip">Scroll</span><span class="chip">Auto-play</span></div>
        </div>
        <div id="homeFeed" class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
      </div>
    </section>

    <!-- MOMENTS (Stories row + composer + vertical reels feed) -->
    <section id="tab-moments" class="hidden space-y-4">
      <!-- Stories row -->
      <div class="rounded-2xl border border-black/10 bg-white/80 p-4 card">
        <div class="flex items-center justify-between">
          <div class="text-xs uppercase tracking-widest text-black/50">Stories (48h)</div>
          <label class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm cursor-pointer">
            ‚ûï Add Story <input id="storyFile" type="file" accept="video/*,image/*" class="hidden">
          </label>
        </div>
        <div id="storiesRow" class="mt-3 flex gap-3 overflow-x-auto pb-2"></div>
      </div>

      <div class="grid grid-cols-1 gap-4 lg:grid-cols-3">
        <!-- Composer -->
        <div class="order-2 lg:order-1 lg:col-span-1 rounded-2xl border border-black/10 bg-white/80 p-4 card h-max">
          <div class="text-xs uppercase tracking-widest text-black/50">Create a Moment</div>
          <div class="mt-3 grid gap-2 text-sm">
            <label class="rounded-xl border border-black/10 bg-white/80 px-3 py-2 shadow-sm cursor-pointer">üì§ Upload video/image
              <input id="momFile" type="file" accept="video/*,image/*" class="hidden">
            </label>
            <input id="momCaption" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Caption" />
            <input id="momTags" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="#tags, comma separated" />
            <input id="momLink" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Optional link (https://)" />
            <button id="momPost" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">Post Moment</button>
            <small class="text-black/50">Media is uploaded to this repo and served from GitHub Pages.</small>
          </div>
        </div>

        <!-- Reels feed -->
        <div class="order-1 lg:order-2 lg:col-span-2 rounded-2xl border border-black/10 bg-white/80 p-0 card">
          <div class="flex items-center justify-between p-4">
            <div class="text-xs uppercase tracking-widest text-black/50">Moments</div>
            <div class="flex items-center gap-2 text-xs"><span class="chip">J/K to nav</span></div>
          </div>
          <div id="momFeed" class="mom-feed px-3 pb-4 space-y-4"></div>
        </div>
      </div>
    </section>

    <!-- COMMUNICATION -->
    <section id="tab-chat" class="hidden space-y-6">
      <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
        <div class="md:col-span-2 rounded-2xl border border-black/10 bg-white/80 p-4 card">
          <div class="text-xs uppercase tracking-widest text-black/50">Direct Messages</div>
          <div id="dmTitle" class="mt-1 text-xs font-semibold text-black/70"></div>
          <div id="chatLog" class="mt-3 h-72 overflow-y-auto rounded-xl border border-black/5 bg-white/70 p-3 text-sm"></div>
          <div class="mt-3 flex gap-2">
            <input id="chatMsg" class="w-full rounded-xl border border-black/10 bg-white/80 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-black/10" placeholder="Type a message‚Ä¶" />
            <button id="chatSend" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2 text-sm font-semibold shadow-sm">Send</button>
          </div>
        </div>
        <div class="rounded-2xl border border-black/10 bg-white/80 p-4 card">
          <div class="text-xs uppercase tracking-widest text-black/50">People</div>
          <div class="mt-3 grid gap-2 text-sm">
            <input id="peopleSearch" class="rounded-xl border border-black/10 bg-white/80 px-3 py-2" placeholder="Search people (name or @login)" />
            <div id="peopleList" class="mt-1 grid gap-2 max-h-72 overflow-y-auto"></div>
            <small class="text-black/50">Shows users who have signed up (created profiles).</small>
          </div>
        </div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="tab-profile" class="hidden space-y-6">
      <div class="rounded-2xl border border-black/10 bg-white/80 p-4 card">
        <div class="text-xs uppercase tracking-widest text-black/50">Your Profile</div>
        <div class="mt-3 grid gap-3 text-sm md:grid-cols-2">
          <div class="flex items-center gap-3">
            <img id="profAvatar" class="h-12 w-12 rounded-full border border-black/10" src="" alt="">
            <div>
              <div id="profName" class="font-semibold">‚Äî</div>
              <div id="profHandle" class="text-xs text-black/60">‚Äî</div>
            </div>
          </div>
          <div>
            <textarea id="profBio" rows="3" class="w-full rounded-xl border border-black/10 bg-white/80 p-3 text-sm" placeholder="Your bio"></textarea>
            <div class="mt-2 text-right">
              <button id="profSave" class="rounded-full border border-black/10 bg-white/80 px-3 py-1 text-xs font-semibold shadow-sm">Save Profile</button>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <footer class="mt-6 grid place-items-center pb-16 text-center text-xs text-black/60">
    <div>All data stored in this repo (GitHub Pages). No servers.</div>
  </footer>

  <!-- Modal (settings, story viewer) -->
  <div id="modal" class="hidden fixed inset-0 z-50 grid place-items-center bg-black/60 p-4"></div>

  <!-- üëâüëâ Paste Part 2 (the big <script> block) right before </body> üëá -->

---

# Part 2 ‚Äî App logic (paste just before `</body>`)

```html
<script>
/* =========================================================================
   Moments (Pages-only) ‚Äî Single-repo architecture
   Repo used for BOTH hosting and data: hunter9201/moments
   Pages base: https://hunter9201.github.io/moments
   ========================================================================= */
const GH = {
  owner: 'hunter9201',
  repo: 'moments',
  pagesBase: 'https://hunter9201.github.io/moments'
};

// ---------- Tiny helpers ----------
const S = { cfg:'mh:cfg' };
const $ = (id)=>document.getElementById(id);
const get = (k,d)=>{ try{ const v=JSON.parse(localStorage.getItem(k)); return v??d }catch{ return d } };
const set = (k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)) }catch{} };
const token = ()=> (get(S.cfg,{}).gh_pat||'').trim();
const b64e = (s)=> btoa(unescape(encodeURIComponent(s)));
const b64d = (s)=> { try{ return decodeURIComponent(escape(atob(s.replace(/\n/g,'')))) }catch{ return atob(s.replace(/\n/g,'')) } };
const rand = ()=> Math.random().toString(36).slice(2,9);
const nowISO = ()=> new Date().toISOString();
const pagesURL = (path)=> `${GH.pagesBase}/${path.replace(/^\/+/,'')}`;

// ---------- GitHub API (Contents) ----------
async function api(path, opts={}) {
  const h = { 'Accept':'application/vnd.github+json' };
  const t = token(); if(t) h['Authorization'] = `token ${t}`;
  const res = await fetch(`https://api.github.com${path}`, { ...opts, headers: { ...h, ...(opts.headers||{}) } });
  if(!res.ok) throw new Error(`${opts.method||'GET'} ${path} ‚Üí ${res.status}`);
  return res.json();
}
async function defaultBranch(){ 
  const ck='mh:defbranch'; const c=localStorage.getItem(ck); if(c) return c;
  const j = await api(`/repos/${GH.owner}/${GH.repo}`); const b = j.default_branch || 'main';
  localStorage.setItem(ck,b); return b;
}
async function getFile(path){
  try {
    const br = await defaultBranch();
    const j = await api(`/repos/${GH.owner}/${GH.repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(br)}`);
    if(j && j.content) { const txt = b64d(j.content); try { return { sha:j.sha, text:txt, json: JSON.parse(txt) } } catch { return { sha:j.sha, text:txt, json:null } } }
    return { sha:j.sha, text:null, json:null };
  } catch(e){ if(String(e).includes('404')) return null; throw e }
}
async function putJson(path, obj, message){
  const br = await defaultBranch();
  const cur = await getFile(path);
  const body = { message: message||`update ${path}`, content: b64e(JSON.stringify(obj,null,2)), branch: br };
  if(cur && cur.sha) body.sha = cur.sha;
  await api(`/repos/${GH.owner}/${GH.repo}/contents/${encodeURIComponent(path)}`, { method:'PUT', body: JSON.stringify(body) });
}
async function putFile(path, file, message){
  const br = await defaultBranch();
  const buf = await file.arrayBuffer();
  const content = btoa(String.fromCharCode(...new Uint8Array(buf)));
  const cur = await getFile(path);
  const body = { message: message||`upload ${path}`, content, branch: br };
  if(cur && cur.sha) body.sha = cur.sha;
  await api(`/repos/${GH.owner}/${GH.repo}/contents/${encodeURIComponent(path)}`, { method:'PUT', body: JSON.stringify(body) });
  return pagesURL(path); // Pages-hosted URL
}

// ---------- Auth / Sign up ----------
async function ghMe(){
  if(!token()) return null;
  const r = await fetch(`https://api.github.com/user`, { headers:{ 'Authorization':`token ${token()}` }});
  if(!r.ok) return null; return r.json();
}
function renderUserBadge(){
  const badge = $('userBadge'), out=$('btnSignOut'), inb=$('btnSignIn');
  const cfg = get(S.cfg,{});
  if(cfg.gh_login){
    badge.textContent = `@${cfg.gh_login}`;
    badge.classList.remove('hidden'); out.classList.remove('hidden'); inb.classList.add('hidden');
  }else{
    badge.classList.add('hidden'); out.classList.add('hidden'); inb.classList.remove('hidden');
  }
}
async function ensureProfile(){
  const me = await ghMe();
  if(!me) throw new Error('Paste a GitHub fine-grained PAT with Contents: Read & Write for this repo.');
  const login = me.login;
  const path = `profiles/${login}.json`;
  const cur = await getFile(path);
  const now = nowISO();
  const prof = cur?.json || { login, display_name: me.name||login, bio:'', avatar_url: me.avatar_url||'', created_at: now };
  await putJson(path, prof, `profile: ${login}`);
  // profiles index
  const idxPath = 'indexes/profiles.json';
  const idxCur = await getFile(idxPath); let arr = Array.isArray(idxCur?.json)? idxCur.json : [];
  arr = [{ login, display_name: prof.display_name, avatar_url: prof.avatar_url }, ...arr.filter(x=>x.login!==login)];
  if(arr.length>5000) arr = arr.slice(0,5000);
  await putJson(idxPath, arr, `index(profiles): add ${login}`);
  // cache for UI
  set(S.cfg,{...get(S.cfg,{}), gh_login:login, gh_name:prof.display_name, gh_avatar:prof.avatar_url});
  renderUserBadge();
  loadPeople();
  loadProfileUI();
  return prof;
}
$('btnSignIn').onclick = async ()=>{
  let pat = token();
  if(!pat){
    pat = prompt('Paste your GitHub fine-grained PAT (Contents: Read & Write for this repo)');
    if(!pat) return;
    set(S.cfg,{...get(S.cfg,{}), gh_pat: pat.trim()});
  }
  try{ await ensureProfile(); alert('Signed in ‚úì'); }catch(e){ alert(e.message||String(e)) }
};
$('btnSignOut').onclick = ()=>{
  set(S.cfg,{...get(S.cfg,{}), gh_pat:'', gh_login:'', gh_name:'', gh_avatar:''});
  renderUserBadge(); alert('Signed out');
};
renderUserBadge();

// ---------- Tabs ----------
const tabs = ['home','moments','chat','profile'];
function switchTab(t){ tabs.forEach(k=> $(`tab-${k}`).classList.toggle('hidden', k!==t)); }
document.querySelectorAll('.tab-btn').forEach(b=> b.addEventListener('click', ()=> switchTab(b.dataset.tab)));
switchTab('home');

// ---------- Profile panel ----------
async function loadProfileUI(){
  const me = get(S.cfg,{}).gh_login; if(!me){ $('profName').textContent='Not signed in'; $('profHandle').textContent='‚Äî'; $('profAvatar').src=''; return; }
  $('profHandle').textContent = '@'+me;
  const profFile = await getFile(`profiles/${me}.json`); const p = profFile?.json || {};
  $('profName').textContent = p.display_name || me;
  $('profBio').value = p.bio || '';
  $('profAvatar').src = p.avatar_url || '';
}
$('profSave').onclick = async ()=>{
  const me = get(S.cfg,{}).gh_login; if(!me) return alert('Sign in first');
  const profFile = await getFile(`profiles/${me}.json`); const p = profFile?.json || { login:me, created_at: nowISO() };
  p.display_name = $('profName').textContent || p.display_name || me;
  p.bio = $('profBio').value || '';
  await putJson(`profiles/${me}.json`, p, `profile update: ${me}`);
  // Also update index name if needed
  const idxCur = await getFile('indexes/profiles.json'); let arr = Array.isArray(idxCur?.json)? idxCur.json: [];
  arr = [{ login: me, display_name: p.display_name, avatar_url: p.avatar_url||'' }, ...arr.filter(x=>x.login!==me)];
  await putJson('indexes/profiles.json', arr, `index(profiles): update ${me}`);
  alert('Profile saved ‚úì'); loadPeople(); renderFeeds();
};
loadProfileUI();

// ---------- People directory ----------
async function fetchJson(url){ try{ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) return null; return r.json(); }catch{ return null } }
async function profilesIndex(){
  const j = await fetchJson(pagesURL('indexes/profiles.json'));
  return Array.isArray(j)? j : [];
}
async function loadPeople(){
  const list = $('peopleList'); if(!list) return;
  list.innerHTML = `<div class='text-xs text-black/60'>Loading‚Ä¶</div>`;
  const q = ($('peopleSearch')?.value||'').toLowerCase().trim();
  const me = get(S.cfg,{}).gh_login||'';
  const idx = await profilesIndex();
  const filtered = idx.filter(p=> p.login!==me && (!q || (p.display_name?.toLowerCase().includes(q) || p.login.toLowerCase().includes(q))));
  if(!filtered.length){ list.innerHTML = `<div class='text-xs text-black/60'>No people yet.</div>`; return }
  list.innerHTML = '';
  filtered.forEach(p=>{
    const row = document.createElement('button');
    row.className='flex items-center justify-between rounded-xl border border-black/10 bg-white/70 px-3 py-2 text-left shadow-sm';
    row.innerHTML = `<div class='flex items-center gap-2'>${p.avatar_url? `<img src='${p.avatar_url}' class='h-6 w-6 rounded-full'>`:''}<div><div class='font-semibold'>${p.display_name||p.login}</div><div class='text-[11px] text-black/60'>@${p.login}</div></div></div><span class='text-xs'>Chat</span>`;
    row.onclick = ()=> openDM(p.login);
    list.appendChild(row);
  });
}
$('peopleSearch')?.addEventListener('input', loadPeople);
loadPeople();

// ---------- DMs ----------
function threadId(a,b){ return [a,b].sort().join('__') }
async function loadThread(peer){
  const me = get(S.cfg,{}).gh_login; if(!me){ $('dmTitle').textContent='Sign in to chat'; $('chatLog').innerHTML=''; return }
  $('dmTitle').textContent = `Chat with @${peer}`;
  const id = threadId(me, peer);
  const t = await fetchJson(pagesURL(`dms/${id}.json`)) || { id, messages:[] };
  renderThread(t);
}
function renderThread(t){
  const host=$('chatLog'); if(!host) return; host.innerHTML='';
  const me = get(S.cfg,{}).gh_login||'';
  (t.messages||[]).forEach(m=>{
    const mine = m.author===me;
    const div = document.createElement('div'); div.className=`mb-2 ${mine?'text-right':''}`;
    div.innerHTML = `<div class='inline-block rounded-xl px-3 py-2 text-sm ${mine?'bg-sky-100':'bg-white/70'}'>${m.text}</div>
                     <div class='text-[10px] text-black/50'>${new Date(m.ts).toLocaleString()}</div>`;
    host.appendChild(div);
  });
  host.scrollTop = host.scrollHeight;
}
$('chatSend').onclick = async ()=>{
  const peer = ($('dmTitle').textContent||'').replace(/^Chat with @/,'').trim();
  const text = ($('chatMsg').value||'').trim(); if(!peer || !text) return;
  try{
    const me = await ghMe(); if(!me) return alert('Sign in first');
    const id = threadId(me.login, peer);
    const path = `dms/${id}.json`;
    const cur = await getFile(path);
    const thread = cur?.json || { id, participants: [me.login, peer], messages: [] };
    thread.messages.push({ id: `${Date.now()}_${rand()}`, author: me.login, text, ts: Date.now() });
    await putJson(path, thread, `dm: ${me.login} ‚Üí ${peer}`);
    $('chatMsg').value=''; renderThread(thread);
  }catch(e){ alert(e.message||String(e)) }
};
async function openDM(peerLogin){ await loadThread(peerLogin); }
window.openDM = openDM;

// ---------- Moments (reels) ----------
async function profilesMap(){ const arr = await profilesIndex(); const m={}; arr.forEach(p=> m[p.login]=p); return m }
function momentCard(m, prof){
  const name = prof?.display_name || m.author || 'user';
  const avatar = prof?.avatar_url || '';
  const wrap = document.createElement('div'); wrap.className='mom-item rounded-2xl border border-black/10 bg-black/90 text-white overflow-hidden relative';
  wrap.dataset.searchable = `${m.caption||''} ${(m.tags||[]).join(' ')}`.toLowerCase();
  wrap.innerHTML = `
    <div class='aspect-[9/16] w-full relative'>
      ${m.kind==='video'
        ? `<video class='mom-video absolute inset-0 h-full w-full object-cover' src='${m.media_url||m.src}' playsinline muted loop></video>`
        : `<img class='absolute inset-0 h-full w-full object-cover' src='${m.media_url||m.src}' alt=''>`}
      <div class='absolute inset-x-0 bottom-0 p-3 bg-gradient-to-t from-black/70 to-black/0'>
        <div class='flex items-center gap-2'>${avatar? `<img src='${avatar}' class='h-5 w-5 rounded-full'>`:''}<div class='text-sm font-semibold'>${name}</div></div>
        <div class='text-sm opacity-90'>${m.caption||''}</div>
        <div class='text-xs opacity-70'>${(m.tags||[]).map(t=>'#'+t).join(' ')}</div>
      </div>
      <div class='absolute right-2 top-2 flex flex-col gap-2'>
        ${m.link? `<a class='rounded-full bg-white/10 px-3 py-1 text-xs' target='_blank' href='${m.link}'>üîó Link</a>`:''}
      </div>
    </div>`;
  return wrap;
}
async function renderMoments(){
  const host = $('momFeed'); if(!host) return; host.innerHTML='';
  const idx = await fetchJson(pagesURL('indexes/moments.json')) || [];
  if(!idx.length){ host.innerHTML = `<div class='text-sm text-white/80 p-3'>No moments yet ‚Äî be the first to post!</div>`; return }
  const pmap = await profilesMap();
  idx.forEach(m=> host.appendChild(momentCard(m, pmap[m.author])));
  // autoplay
  const vids = Array.from(document.querySelectorAll('.mom-video'));
  if('IntersectionObserver' in window){
    const obs = new IntersectionObserver((entries)=> entries.forEach(en=>{
      const v=en.target; if(en.isIntersecting && en.intersectionRatio>0.6){ v.play().catch(()=>{}) } else { v.pause() }
    }), {threshold:[0,0.6,1]});
    vids.forEach(v=> obs.observe(v));
  } else { vids.forEach(v=> v.play && v.play().catch(()=>{})); }
}

// Composer -> upload -> write moment json -> update index
let momFileObj = null;
$('momFile').addEventListener('change', (e)=>{ momFileObj = e.target.files?.[0] || null; if(momFileObj) $('momCaption').focus(); });
$('momPost').onclick = async ()=>{
  if(!momFileObj) return alert('Upload a video or image first');
  const me = await ghMe(); if(!me) return alert('Sign in first');
  try{
    const ymd = new Date().toISOString().slice(0,10);
    const folder = momFileObj.type.startsWith('video') ? `media/moments/video/${ymd}` : `media/moments/image/${ymd}`;
    const fname = `${Date.now()}_${rand()}_${(momFileObj.name||'file').replace(/[^a-zA-Z0-9._-]/g,'_')}`;
    const fullPath = `${folder}/${fname}`;
    const mediaUrl = await putFile(fullPath, momFileObj, `moment media: ${me.login}`);
    const meta = {
      id: `${Date.now()}_${rand()}`,
      author: me.login,
      kind: momFileObj.type.startsWith('video') ? 'video':'image',
      src: mediaUrl, media_url: mediaUrl,
      caption: $('momCaption').value.trim(),
      tags: $('momTags').value.split(',').map(s=>s.trim().replace(/^#/,'')).filter(Boolean),
      link: $('momLink').value.trim() || null,
      created_at: nowISO()
    };
    await putJson(`moments/${meta.id}.json`, meta, `moment: ${meta.id}`);
    // update index
    const cur = await getFile('indexes/moments.json'); let idx = Array.isArray(cur?.json)? cur.json : [];
    idx = [meta, ...idx.filter(x=>x.id!==meta.id)]; if(idx.length>2000) idx = idx.slice(0,2000);
    await putJson('indexes/moments.json', idx, `index(moments): add ${meta.id}`);
    // reset form
    $('momCaption').value=''; $('momTags').value=''; $('momLink').value=''; $('momFile').value=''; momFileObj=null;
    alert('Posted ‚úì'); renderMoments(); renderHome();
  }catch(e){ alert(e.message||String(e)) }
};

// ---------- Stories (48h) ----------
function storyChip(s, prof){
  const name = prof?.display_name || s.author || 'Story';
  const el = document.createElement('button'); el.className='flex flex-col items-center gap-1';
  el.innerHTML = `<span class='block h-16 w-16 rounded-full border-2 border-fuchsia-400 overflow-hidden'>
    ${s.kind==='image' ? `<img src='${s.thumb||s.src}' class='h-full w-full object-cover'>` : `<video src='${s.src}' class='h-full w-full object-cover' muted></video>`}
  </span><span class='text-[11px] max-w-20 truncate'>${name}</span>`;
  el.onclick = ()=> openStoryViewer(s);
  return el;
}
async function renderStories(){
  const row = $('storiesRow'); if(!row) return; row.innerHTML='';
  const all = await fetchJson(pagesURL('indexes/stories.json')) || [];
  const active = all.filter(s=> !s.expires_at || new Date(s.expires_at).getTime() > Date.now());
  if(!active.length){ row.innerHTML = `<div class="text-xs text-black/60">No active stories</div>`; return }
  const pmap = await profilesMap();
  active.forEach(s=> row.appendChild(storyChip(s, pmap[s.author])));
}
function openStoryViewer(story){
  const modal = $('modal'); modal.classList.remove('hidden');
  modal.innerHTML = `
    <div class='w-full max-w-sm rounded-2xl bg-black text-white overflow-hidden'>
      <div class='story-progress'><div id='stBar'></div></div>
      <div id='stWrap' class='aspect-[9/16] w-full bg-black grid place-items-center'></div>
      <div class='p-3 flex items-center justify-between text-sm'>
        <div id='stMeta' class='truncate'></div>
        <div class='flex gap-2'>
          <button id='stClose' class='chip bg-white/10'>Close</button>
        </div>
      </div>
    </div>`;
  const bar=$('stBar'), wrap=$('stWrap'), meta=$('stMeta');
  if(story.kind==='video'){ const v=document.createElement('video'); v.src=story.src; v.autoplay=true; v.muted=true; v.playsInline=true; v.className='h-full w-full object-cover'; wrap.appendChild(v); }
  else{ const img=document.createElement('img'); img.src=story.src; img.className='h-full w-full object-cover'; wrap.appendChild(img); }
  meta.textContent = (story.author||'') + (story.caption? ' ‚Äî '+story.caption:'');
  let t0=Date.now(), dur=7000, timer=setInterval(()=>{ const p=Math.min(1,(Date.now()-t0)/dur); bar.style.width=(p*100)+'%'; if(p>=1){ clearInterval(timer); modal.classList.add('hidden'); } }, 50);
  $('stClose').onclick = ()=>{ clearInterval(timer); modal.classList.add('hidden'); };
}
$('storyFile').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const me = await ghMe(); if(!me) { alert('Sign in first'); e.target.value=''; return }
  try{
    const ymd = new Date().toISOString().slice(0,10);
    const folder = f.type.startsWith('video') ? `media/stories/video/${ymd}` : `media/stories/image/${ymd}`;
    const fullPath = `${folder}/${Date.now()}_${rand()}_${(f.name||'file').replace(/[^a-zA-Z0-9._-]/g,'_')}`;
    const url = await putFile(fullPath, f, `story media: ${me.login}`);
    const meta = {
      id: `${Date.now()}_${rand()}`,
      author: me.login,
      kind: f.type.startsWith('video') ? 'video' : 'image',
      src: url, thumb: url,
      caption: 'New story',
      created_at: nowISO(),
      expires_at: new Date(Date.now() + 48*60*60*1000).toISOString()
    };
    await putJson(`stories/${meta.id}.json`, meta, `story: ${meta.id}`);
    const cur = await getFile('indexes/stories.json'); let idx = Array.isArray(cur?.json)? cur.json : [];
    idx = [meta, ...idx.filter(x=>x.id!==meta.id)];
    await putJson('indexes/stories.json', idx, `index(stories): add ${meta.id}`);
    alert('Story posted ‚úì'); renderStories();
  }catch(e){ alert(e.message||String(e)) }
  e.target.value='';
});

// ---------- Home feed (grid from moments index) ----------
function homeCard(m, prof){
  const name = prof?.display_name || m.author || 'user';
  const avatar = prof?.avatar_url || '';
  const el = document.createElement('div'); el.className='group overflow-hidden rounded-2xl border bg-white shadow card';
  el.innerHTML = `
    <div class="relative">
      ${m.kind==='video'
        ? `<video class='h-56 w-full object-cover' src='${m.media_url||m.src}' muted playsinline loop></video>`
        : `<img class='h-56 w-full object-cover' src='${m.media_url||m.src}' alt=''>`}
      <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-3 text-white">
        <div class="flex items-center gap-2 text-sm">
          ${avatar? `<img src='${avatar}' class='h-5 w-5 rounded-full border border-white/20'>`:''}
          <span class="font-semibold">${name}</span>
        </div>
        <div class="text-xs opacity-90">${m.caption||''}</div>
      </div>
    </div>
  `;
  return el;
}
async function renderHome(){
  const host = $('homeFeed'); if(!host) return; host.innerHTML='';
  const idx = await fetchJson(pagesURL('indexes/moments.json')) || [];
  const pmap = await profilesMap();
  if(!idx.length){ host.innerHTML = `<div class='text-xs text-black/60'>No posts yet.</div>`; return }
  idx.forEach(m=> host.appendChild(homeCard(m, pmap[m.author])));
}
function renderFeeds(){ renderHome(); renderMoments(); renderStories(); }
renderFeeds();

// ---------- Search (client filter) ----------
$('search').addEventListener('input', (e)=>{
  const q = e.target.value.toLowerCase().trim();
  // home
  Array.from(($('homeFeed')||{}).children||[]).forEach(c=> c.style.display = c.textContent.toLowerCase().includes(q) ? '' : 'none');
  // moments
  Array.from(($('momFeed')||{}).children||[]).forEach(c=> c.style.display = (c.dataset.searchable||'').includes(q) ? '' : 'none');
});

// ---------- Keyboard nav for reels ----------
document.addEventListener('keydown', (e)=>{
  if($('tab-moments').classList.contains('hidden')) return;
  const host = $('momFeed');
  if(e.key.toLowerCase()==='j'){ host.scrollBy({top:host.clientHeight*0.9, behavior:'smooth'}) }
  if(e.key.toLowerCase()==='k'){ host.scrollBy({top:-host.clientHeight*0.9, behavior:'smooth'}) }
});

// ---------- Settings modal (change PAT / info) ----------
$('openSettings').onclick = ()=>{
  const modal = $('modal'); modal.classList.remove('hidden');
  modal.innerHTML = `
    <div class='max-w-md w-full rounded-2xl bg-white p-4'>
      <div class='flex items-center justify-between mb-2'>
        <div class='text-xs uppercase tracking-widest text-black/50'>Settings</div>
        <button class='chip' id='setClose'>Close</button>
      </div>
      <div class='space-y-3 text-sm'>
        <div>
          <div class='font-semibold'>Repository</div>
          <div class='text-black/60'><code>${GH.owner}/${GH.repo}</code> ‚Äî Pages base <code>${GH.pagesBase}</code></div>
        </div>
        <label class='block'>Personal Access Token (PAT)
          <input id='ghToken' type='password' class='mt-1 w-full rounded-xl border border-black/10 bg-white/80 px-3 py-2 text-sm' placeholder='ghp_‚Ä¶ (Fine-grained; Contents: Read & Write)'>
        </label>
        <div class='text-xs text-black/60'>Stored locally in your browser.</div>
        <div class='flex justify-end gap-2'>
          <button id='setSave' class='chip'>Save</button>
        </div>
      </div>
    </div>`;
  $('ghToken').value = token();
  $('setClose').onclick = ()=> modal.classList.add('hidden');
  $('setSave').onclick = async ()=>{
    set(S.cfg,{...get(S.cfg,{}), gh_pat: $('ghToken').value.trim()});
    modal.classList.add('hidden');
    try{ await ensureProfile(); alert('Saved & signed in ‚úì'); }catch(e){ alert(e.message||String(e)) }
  };
};
</script>
</body>
</html>
